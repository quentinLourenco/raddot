{% load comment_tag %}
{% load static %}

<link rel="stylesheet" href="{% static 'comment.css' %}">

<div class="post-card">
    <div class="post-header">
        {% if not on_subhomepage %}
            <a href="{% url 'social_app:subraddot_home' name=post.subraddot.name %}" class="subraddot-link">
                {% if post.subraddot.icon %}
                    <img src="{{ post.subraddot.icon.url }}" alt="{{ post.subraddot.name }}" class="subraddot-icon">
                {% endif %}
                <span class="subraddot-name">{{ post.subraddot.name }}</span>
            </a>
            <span class="post-info">
                PostÃ© par {{ post.user.username }} â€¢ {{ post.created_at }}
            </span>
        {% else %}
            <span class="post-info">
                {% if post.user.profile and post.user.profile.picture %}
                    <img src="{{ post.user.profile.picture.url }}" alt="{{ post.user.username }}" class="userpic">
                {% endif %}
                <span class="username">{{ post.user.username }}</span>
                â€¢ {{ post.created_at }}
            </span>
        {% endif %}
    </div>

    <div class="post-body">
        <h3 class="post-title">{{ post.title }}</h3>
        {% if post.post_type == 'text' %}
            <div class="post-content">
                {{ post.content|linebreaksbr }}
            </div>
        {% elif post.post_type == 'image' %}
            <div class="post-image">
                {% if post.img %}
                    <img src="{{ post.img.url }}" alt="{{ post.title }}">
                {% endif %}
                {% if post.content %}
                    <div class="post-content">
                        {{ post.content|linebreaksbr }}
                    </div>
                {% endif %}
            </div>
        {% endif %}
    </div>

    <div class="post-footer">
        <div class="post-actions">
            <div class="vote-container">
                <form method="post" action="{% url 'social_app:vote_post' %}" class="vote-form">
                    {% csrf_token %}
                    <input type="hidden" name="post_id" value="{{ post.id }}">
                    <input type="hidden" name="value" value="{% if user_vote == 1 %}0{% else %}1{% endif %}">
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="vote-btn upvote {% if user_vote == 1 %}active{% endif %}">
                        <img src="{% static 'assets/vers-le-haut.png' %}" alt="Upvote">
                    </button>
                </form>
                <span class="vote-count">{{ total_votes }}</span>
                <form method="post" action="{% url 'social_app:vote_post' %}" class="vote-form">
                    {% csrf_token %}
                    <input type="hidden" name="post_id" value="{{ post.id }}">
                    <input type="hidden" name="value" value="{% if user_vote == -1 %}0{% else %}-1{% endif %}">
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="vote-btn downvote {% if user_vote == -1 %}active{% endif %}">
                        <img src="{% static 'assets/vers-le-bas.png' %}" alt="Downvote">
                    </button>
                </form>
            </div>

            <button class="comments-btn" onclick="toggleComments('comments-{{ post.id }}')">
                <span>ðŸ’¬</span>
                <span class="comments-count">{{ comments_count }}</span> commentaires
            </button>
        </div>
    </div>
    <div id="comments-{{ post.id }}" class="comments-section" style="display: none;">
        {% render_create_comment post %}
        {% for comment in post.comments.all %}
            <div class="comment">
                {% render_comment comment %}
            </div>
        {% empty %}
            <div class="no-comments">No comments yet.</div>
        {% endfor %}
    </div>
</div>

<script>
  function toggleComments(id) {
    const section = document.getElementById(id);
    if (section.style.display === "none") {
      section.style.display = "block";
    } else {
      section.style.display = "none";
    }
  }
</script>
